# -*- coding: utf-8 -*-
import time
from pathlib import Path

from demos.realtime.backend.asr_client_factory import AsrClientFactory
from agentbricks.components.realtime_clients.azure_asr_client import (
    AzureAsrCallbacks,
    AzureAsrClient,
)
from agentbricks.components.realtime_clients.bailian_asr_client import (
    BailianAsrClient,
    BailianAsrConfig,
    BailianAsrCallbacks,
)
from agentbricks.schemas.realtime import (
    AzureAsrConfig,
    AsrVendor,
    AsrConfig,
)


def test_bailian_asr_client():
    def on_asr_event(sentence_end: bool, sentence_text: str) -> None:
        print(f"on_asr_event: end={sentence_end}, text={sentence_text}")

    current_dir = Path(__file__).parent
    resources_dir = current_dir / ".." / "resources"
    file = open(resources_dir / "tts.pcm", "wb")

    config = BailianAsrConfig()

    callbacks = BailianAsrCallbacks(on_event=on_asr_event)

    asr_client = BailianAsrClient(config, callbacks)

    asr_client.start()

    with open(resources_dir / "chat.pcm", "rb") as f:
        while True:
            data = f.read(3200)
            if not data:
                break
            asr_client.send_audio_data(data)
            time.sleep(0.01)

    asr_client.stop()

    asr_client.close()

    file.close()


def test_azure_asr_client():
    def on_asr_event(sentence_end: bool, sentence_text: str) -> None:
        print(f"on_asr_event: end={sentence_end}, text={sentence_text}")

    config = AzureAsrConfig()

    callbacks = AzureAsrCallbacks(on_event=on_asr_event)

    asr_client = AzureAsrClient(config, callbacks)

    asr_client.start()
    current_dir = Path(__file__).parent
    resources_dir = current_dir / ".." / "resources"

    with open(resources_dir / "chat-en.pcm", "rb") as f:
        while True:
            data = f.read(3200)
            if not data:
                break
            asr_client.send_audio_data(data)
            time.sleep(0.01)

    # time.sleep(15)

    asr_client.stop()

    time.sleep(10)
    # asr_client.close()


def test_asr_client_factory():
    asr_options = AsrConfig(model="gummy-realtime-v1")
    asr_client = AsrClientFactory.get_config(AsrVendor.BAILIAN, asr_options)
    print("asr_client: %s" % asr_client)
