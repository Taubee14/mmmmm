# -*- coding: utf-8 -*-
import pytest
from unittest.mock import patch, MagicMock

from agentbricks.components.storages.oss import OssComponent, OssInput


@pytest.fixture
def oss_component():
    return OssComponent(
        access_key_id="test_access_key_id",
        access_key_secret="test_access_key_secret",  # pragma: allowlist secret
        endpoint="https://oss-cn-beijing.aliyuncs.com",
        name="test_oss_component",
        description="Test OSS Component",
    )


@patch("agentbricks.components.storages.oss.oss2")
def test_oss_read_success(mock_oss2, oss_component):
    # Mock OSS bucket and object
    mock_bucket = MagicMock()
    mock_oss2.Bucket.return_value = mock_bucket
    mock_object = MagicMock()
    mock_object.read.return_value = b"test content"
    mock_bucket.get_object.return_value = mock_object

    # Prepare input data
    input_data = OssInput(
        bucket="test-bucket",
        key="test-key.txt",
        operation="read",
    )

    # Call the _arun method
    result = oss_component.run(input_data)

    # Assertions to verify the result
    assert result.success is True
    assert result.content == "test content"
    assert "读取成功" in result.message
    mock_bucket.get_object.assert_called_once_with("test-key.txt")


@patch("agentbricks.components.storages.oss.oss2")
def test_oss_write_success(mock_oss2, oss_component):
    # Mock OSS bucket
    mock_bucket = MagicMock()
    mock_oss2.Bucket.return_value = mock_bucket

    # Prepare input data
    input_data = OssInput(
        bucket="test-bucket",
        key="test-key.txt",
        operation="write",
        content="test content to write",
    )

    # Call the _arun method
    result = oss_component.run(input_data)

    # Assertions to verify the result
    assert result.success is True
    assert "写入成功" in result.message
    mock_bucket.put_object.assert_called_once_with(
        "test-key.txt",
        "test content to write",
    )


@patch("agentbricks.components.storages.oss.oss2")
def test_oss_delete_success(mock_oss2, oss_component):
    # Mock OSS bucket
    mock_bucket = MagicMock()
    mock_oss2.Bucket.return_value = mock_bucket

    # Prepare input data
    input_data = OssInput(
        bucket="test-bucket",
        key="test-key.txt",
        operation="delete",
    )

    # Call the _arun method
    result = oss_component.run(input_data)

    # Assertions to verify the result
    assert result.success is True
    assert "删除" in result.message
    mock_bucket.delete_object.assert_called_once_with("test-key.txt")


@patch("agentbricks.components.storages.oss.oss2")
def test_oss_unsupported_operation(mock_oss2, oss_component):
    # Prepare input data
    input_data = OssInput(
        bucket="test-bucket",
        key="test-key.txt",
        operation="unsupported",
    )

    # Call the _arun method
    result = oss_component.run(input_data)

    # Assertions to verify the result
    assert result.success is False
    assert "不支持的操作类型" in result.message
