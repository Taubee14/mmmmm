# -*- coding: utf-8 -*-
import pytest
from unittest.mock import patch, MagicMock

from agentbricks.components.storages.rds import RdsComponent, RdsInput


@pytest.fixture
def rds_component():
    return RdsComponent(
        host="test-host",
        port=3306,
        user="test-user",
        password="test-password",  # pragma: allowlist secret
        database="test-database",
        name="test_rds_component",
        description="Test RDS Component",
    )


@patch("agentbricks.components.storages.rds.pymysql")
def test_rds_query_success(mock_pymysql, rds_component):
    # Mock database connection and cursor
    mock_connection = MagicMock()
    mock_cursor = MagicMock()
    mock_pymysql.connect.return_value = mock_connection
    mock_connection.cursor.return_value.__enter__.return_value = mock_cursor
    mock_cursor.fetchall.return_value = [
        {"id": 1, "name": "test1"},
        {"id": 2, "name": "test2"},
    ]

    # Prepare input data
    input_data = RdsInput(
        query="SELECT * FROM test_table",
        operation="query",
    )

    # Call the _arun method
    result = rds_component.run(input_data)

    # Assertions to verify the result
    assert result.success is True
    assert len(result.results) == 2
    assert result.results[0]["id"] == 1
    assert "查询成功" in result.message
    mock_cursor.execute.assert_called_once_with("SELECT * FROM test_table", ())


@patch("agentbricks.components.storages.rds.pymysql")
def test_rds_execute_success(mock_pymysql, rds_component):
    # Mock database connection and cursor
    mock_connection = MagicMock()
    mock_cursor = MagicMock()
    mock_pymysql.connect.return_value = mock_connection
    mock_connection.cursor.return_value.__enter__.return_value = mock_cursor
    mock_cursor.execute.return_value = 5  # Affected rows

    # Prepare input data
    input_data = RdsInput(
        query="UPDATE test_table SET name='updated' WHERE id=1",
        operation="execute",
    )

    # Call the _arun method
    result = rds_component.run(input_data)

    # Assertions to verify the result
    assert result.success is True
    assert result.affected_rows == 5
    assert "执行成功" in result.message
    mock_cursor.execute.assert_called_once_with(
        "UPDATE test_table SET name='updated' WHERE id=1",
        (),
    )


@patch("agentbricks.components.storages.rds.pymysql")
def test_rds_query_with_params(mock_pymysql, rds_component):
    # Mock database connection and cursor
    mock_connection = MagicMock()
    mock_cursor = MagicMock()
    mock_pymysql.connect.return_value = mock_connection
    mock_connection.cursor.return_value.__enter__.return_value = mock_cursor
    mock_cursor.fetchall.return_value = [{"id": 1, "name": "test"}]

    # Prepare input data with parameters
    input_data = RdsInput(
        query="SELECT * FROM test_table WHERE id=%s",
        operation="query",
        params={"id": 1},
    )

    # Call the _arun method
    result = rds_component.run(input_data)

    # Assertions to verify the result
    assert result.success is True
    mock_cursor.execute.assert_called_once_with(
        "SELECT * FROM test_table WHERE id=%s",
        {"id": 1},
    )


@patch("agentbricks.components.storages.rds.pymysql")
def test_rds_unsupported_operation(mock_pymysql, rds_component):
    # Prepare input data
    input_data = RdsInput(
        query="SELECT * FROM test_table",
        operation="unsupported",
    )

    # Call the _arun method
    result = rds_component.run(input_data)

    # Assertions to verify the result
    assert result.success is False
    assert "不支持的操作类型" in result.message


@patch("agentbricks.components.storages.rds.pymysql")
def test_rds_connection_error(mock_pymysql, rds_component):
    # Mock connection error
    mock_pymysql.connect.side_effect = Exception("Connection failed")

    # Prepare input data
    input_data = RdsInput(
        query="SELECT * FROM test_table",
        operation="query",
    )

    # Call the _arun method
    result = rds_component.run(input_data)

    # Assertions to verify the result
    assert result.success is False
    assert "Connection failed" in result.message
