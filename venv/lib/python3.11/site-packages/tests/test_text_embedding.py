# -*- coding: utf-8 -*-
import pytest
from openai.types import CreateEmbeddingResponse

from agentbricks.models.embedding import TextEmbedding


# Fixtures
@pytest.fixture
def text_input():
    return "这是一段需要嵌入的文本"


@pytest.fixture
def text_embedding_model():
    return TextEmbedding()


# Tests for TextEmbedding
@pytest.mark.asyncio
async def test_text_embedding_arun(text_embedding_model, text_input):
    response = await text_embedding_model.arun(
        input=text_input,
        model="text-embedding-v1",
    )
    assert isinstance(response, CreateEmbeddingResponse)
    assert len(response.data) > 0
    assert hasattr(response.data[0], "embedding")


@pytest.mark.asyncio
async def test_text_embedding_with_dimensions(
    text_embedding_model,
    text_input,
):
    response = await text_embedding_model.arun(
        input=text_input,
        model="text-embedding-v3",
        dimensions=768,
    )
    assert len(response.data[0].embedding) == 768


@pytest.mark.asyncio
async def test_text_embedding_with_base64_encoding(
    text_embedding_model,
    text_input,
):
    response = await text_embedding_model.arun(
        input=text_input,
        model="text-embedding-v4",
        encoding_format="base64",
    )
    assert isinstance(response.data[0].embedding, str)  # base64 string


@pytest.mark.asyncio
async def test_batch_text_embedding(text_embedding_model, text_input):
    inputs = [
        text_input,
        text_input,
    ]
    response = await text_embedding_model.arun(
        input=inputs,
        model="text-embedding-v4",
        encoding_format="base64",
    )
    assert len(response.data) == len(inputs)
    assert isinstance(response.data[0].embedding, str)  # base64 string


@pytest.mark.asyncio
async def test_text_embedding_invalid_model(text_embedding_model, text_input):
    with pytest.raises(Exception):
        await text_embedding_model.arun(
            input=text_input,
            model="invalid-model",
        )
