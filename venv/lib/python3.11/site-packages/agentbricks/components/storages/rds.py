# -*- coding: utf-8 -*-
from agentbricks.base.component import Component
from pydantic import BaseModel, Field
from typing import Optional, Any, List, Dict
import pymysql


class RdsInput(BaseModel):
    query: str = Field(..., description="SQL查询语句")
    operation: str = Field(..., description="操作类型: query/execute")
    params: Optional[Dict[str, Any]] = Field(None, description="查询参数")


class RdsOutput(BaseModel):
    success: bool = Field(description="操作是否成功")
    results: Optional[List[Dict[str, Any]]] = Field(
        None,
        description="查询结果",
    )
    affected_rows: Optional[int] = Field(None, description="影响的行数")
    message: Optional[str] = Field(None, description="操作结果消息")


class RdsComponent(Component[RdsInput, RdsOutput]):
    """关系型数据库组件，支持MySQL查询和执行"""

    name = "rds_component"
    description = "关系型数据库组件，支持MySQL查询和执行"

    def __init__(
        self,
        host: str,
        port: int,
        user: str,
        password: str,
        database: str,
        **kwargs: Any,
    ):
        """初始化RDS组件

        Args:
            host: 数据库主机地址
            port: 数据库端口
            user: 数据库用户名
            password: 数据库密码
            database: 数据库名称
            **kwargs: 其他组件参数
        """
        super().__init__(**kwargs)
        self.connection_params = {
            "host": host,
            "port": port,
            "user": user,
            "password": password,
            "database": database,
            "charset": "utf8mb4",
            "autocommit": True,
        }

    async def _arun(self, args: RdsInput, **kwargs: Any) -> RdsOutput:
        """执行RDS操作

        Args:
            args: RdsInput包含query, operation和params
            **kwargs: 其他参数

        Returns:
            RdsOutput: 操作结果
        """
        try:
            # 建立数据库连接
            connection = pymysql.connect(**self.connection_params)

            try:
                with connection.cursor(pymysql.cursors.DictCursor) as cursor:
                    if args.operation == "query":
                        # 执行查询
                        cursor.execute(args.query, args.params or ())
                        results = cursor.fetchall()
                        return RdsOutput(
                            success=True,
                            results=results,
                            message="查询成功",
                        )
                    elif args.operation == "execute":
                        # 执行语句
                        affected_rows = cursor.execute(
                            args.query,
                            args.params or (),
                        )
                        return RdsOutput(
                            success=True,
                            affected_rows=affected_rows,
                            message="执行成功",
                        )
                    else:
                        return RdsOutput(
                            success=False,
                            message="不支持的操作类型",
                        )
            finally:
                connection.close()
        except Exception as e:
            return RdsOutput(success=False, message=str(e))


# 示例使用
if __name__ == "__main__":
    import asyncio

    # 初始化组件（需要替换为实际的数据库信息）
    rds_component = RdsComponent(
        host="your_host",
        port=3306,
        user="your_user",
        password="your_password",  # pragma: allowlist secret
        database="your_database",
        name="rds_query",
        description="查询RDS数据库",
    )

    async def main() -> None:
        # 查询示例
        rds_input = RdsInput(
            query="SELECT * FROM users LIMIT 5",
            operation="query",
        )

        result = await rds_component.arun(rds_input)
        print(f"操作结果: {result.success}")
        print(f"消息: {result.message}")
        if result.results:
            print(f"查询结果: {result.results}")

    # asyncio.run(main())
