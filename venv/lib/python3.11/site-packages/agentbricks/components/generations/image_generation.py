# -*- coding: utf-8 -*-
import asyncio
import os
import time
import uuid
from http import HTTPStatus
from typing import Any, Optional

from dashscope import ImageSynthesis
from mcp.server.fastmcp import Context
from pydantic import BaseModel, Field

from agentbricks.base.component import Component
from agentbricks.tracing import TraceType
from agentbricks.tracing.wrapper import trace
from agentbricks.utils.api_key_util import ApiNames, get_api_key
from agentbricks.utils.mcp_util import MCPUtil


class ImageGenInput(BaseModel):
    """
    æ–‡ç”Ÿå›¾Input
    """

    prompt: str = Field(
        ...,
        description="æ­£å‘æç¤ºè¯ï¼Œç”¨æ¥æè¿°ç”Ÿæˆå›¾åƒä¸­æœŸæœ›åŒ…å«çš„å…ƒç´ å’Œè§†è§‰ç‰¹ç‚¹,è¶…è¿‡800è‡ªåŠ¨æˆªæ–­",
    )
    size: str = Field(
        default="1024*1024",
        description="è¾“å‡ºå›¾åƒçš„åˆ†è¾¨çŽ‡ã€‚é»˜è®¤å€¼æ˜¯1024*1024 æœ€é«˜å¯è¾¾200ä¸‡åƒç´ ",
    )
    n: int = Field(
        default=1,
        description="ç”Ÿæˆå›¾ç‰‡çš„æ•°é‡ã€‚å–å€¼èŒƒå›´ä¸º1~4å¼  é»˜è®¤1",
    )
    watermark: bool = Field(
        default=False,
        description="æ˜¯å¦æ·»åŠ æ°´å°ï¼Œæ°´å°ä½äºŽå›¾ç‰‡å³ä¸‹è§’ï¼Œæ–‡æ¡ˆä¸ºâ€œAIç”Ÿæˆâ€",
    )
    ctx: Optional[Context] = Field(
        default=None,
        description="HTTP request context containing headers for mcp only, "
        "don't generate it",
    )


class ImageGenOutput(BaseModel):
    """
    æ–‡ç”Ÿå›¾ Output.
    """

    results: list[str] = Field(title="Results", description="è¾“å‡ºå›¾ç‰‡url åˆ—è¡¨")
    request_id: Optional[str] = Field(
        default=None,
        title="Request ID",
        description="è¯·æ±‚ID",
    )


class ImageGeneration(Component[ImageGenInput, ImageGenOutput]):
    """
    æ–‡ç”Ÿå›¾è°ƒç”¨.
    """

    name: str = "bailian_image_gen"
    description: str = (
        "AIç»˜ç”»ï¼ˆå›¾åƒç”Ÿæˆï¼‰æœåŠ¡ï¼Œè¾“å…¥æ–‡æœ¬æè¿°å’Œå›¾åƒåˆ†è¾¨çŽ‡ï¼Œè¿”å›žæ ¹æ®æ–‡æœ¬ä¿¡æ¯ç»˜åˆ¶çš„å›¾ç‰‡URLã€‚"
    )

    @trace(trace_type=TraceType.AIGC, trace_name="image_generation")
    async def arun(self, args: ImageGenInput, **kwargs: Any) -> ImageGenOutput:
        """Bailian Images generation from text prompts

        This method wrap DashScope's ImageSynthesis service to generate images
        based on text descriptions. It supports various image sizes and can
        generate multiple images in a single request.

        Args:
            args: ImageGenInput containing the prompt, size, and number of
                images to generate.
            **kwargs: Additional keyword arguments including:
                - request_id: Optional request ID for tracking
                - trace_event: Optional trace event for logging
                - model_name: Model name to use (defaults to wanx2.1-t2i-turbo)
                - api_key: DashScope API key for authentication

        Returns:
            ImageGenOutput containing the list of generated image URLs and
            request ID.

        Raises:
            ValueError: If DASHSCOPE_API_KEY is not set or invalid.
        """

        trace_event = kwargs.pop("trace_event", None)
        request_id = MCPUtil._get_mcp_dash_request_id(args.ctx)
        watermark = os.getenv(
            "ENAABLE_WATERMARK",
            kwargs.pop("watermark", True),
        )
        try:
            token = get_api_key(ApiNames.dashscope_api_key, **kwargs)
        except AssertionError:
            raise ValueError("Please set valid DASHSCOPE_API_KEY!")

        model_name = kwargs.get(
            "model_name",
            os.getenv("MODEL_NAME", "wanx2.1-t2i-turbo"),
        )
        # ðŸ”„ ä½¿ç”¨DashScopeçš„å¼‚æ­¥ä»»åŠ¡APIå®žçŽ°çœŸæ­£çš„å¹¶å‘
        # 1. æäº¤å¼‚æ­¥ä»»åŠ¡

        call_params = {
            "api_key": token,
            "model": model_name,
            "prompt": args.prompt,
            "n": args.n,
            "watermark": watermark,
        }

        if args.size != ImageGenInput.model_fields["size"].default:
            call_params["size"] = args.size

        task_response = ImageSynthesis.async_call(**call_params)

        # 2. å¾ªçŽ¯å¼‚æ­¥æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
        max_wait_time = 300  # 5åˆ†é’Ÿè¶…æ—¶
        poll_interval = 2  # 2ç§’è½®è¯¢é—´éš”
        start_time = time.time()

        while True:
            # å¼‚æ­¥ç­‰å¾…
            await asyncio.sleep(poll_interval)

            # æŸ¥è¯¢ä»»åŠ¡ç»“æžœ
            res = ImageSynthesis.fetch(
                api_key=token,
                task=task_response,
            )

            # æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
            if res.status_code == HTTPStatus.OK:
                if hasattr(res.output, "task_status"):
                    if res.output.task_status == "SUCCEEDED":
                        break
                    elif res.output.task_status in ["FAILED", "CANCELED"]:
                        raise RuntimeError(
                            f"Image generation failed: "
                            f"{res.output.task_status}",
                        )
                else:
                    # å¦‚æžœæ²¡æœ‰task_statuså­—æ®µï¼Œè®¤ä¸ºå·²å®Œæˆ
                    break

            # è¶…æ—¶æ£€æŸ¥
            if time.time() - start_time > max_wait_time:
                raise TimeoutError(
                    f"Image generation timeout after {max_wait_time}s",
                )

        if request_id == "":
            request_id = (
                res.request_id if res.request_id else str(uuid.uuid4())
            )

        if trace_event:
            trace_event.on_log(
                "",
                **{
                    "step_suffix": "results",
                    "payload": {
                        "request_id": request_id,
                        "image_query_result": res,
                    },
                },
            )
        results = []
        if res.status_code == HTTPStatus.OK:
            for result in res.output.results:
                results.append(result.url)
        return ImageGenOutput(results=results, request_id=request_id)


if __name__ == "__main__":

    image_generation = ImageGeneration()

    image_gent_input = ImageGenInput(
        prompt="å¸®æˆ‘ç”»ä¸€ä¸ªå›½å®ç†ŠçŒ«,",
    )

    async def main() -> None:
        image_gent_output = await image_generation.arun(
            image_gent_input,
            model_name="qwen-image",
        )
        print(image_gent_output)
        print(image_generation.function_schema.model_dump())
