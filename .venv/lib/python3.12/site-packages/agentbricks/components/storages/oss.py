# -*- coding: utf-8 -*-
from agentbricks.base.component import Component
from pydantic import BaseModel, Field
from typing import Optional, Any
import oss2
import io


class OssInput(BaseModel):
    bucket: str = Field(..., description="OSS存储桶名称")
    key: str = Field(..., description="文件键名")
    operation: str = Field(..., description="操作类型: read/write/delete")
    content: Optional[str] = Field(None, description="写入内容")


class OssOutput(BaseModel):
    success: bool = Field(description="操作是否成功")
    content: Optional[str] = Field(None, description="读取的文件内容")
    message: Optional[str] = Field(None, description="操作结果消息")


class OssComponent(Component[OssInput, OssOutput]):
    """阿里云OSS存储组件，支持读写操作"""

    name = "oss_component"
    description = "阿里云OSS存储组件，支持读写操作"

    def __init__(
        self,
        access_key_id: str,
        access_key_secret: str,
        endpoint: str,
        **kwargs: Any,
    ):
        """初始化OSS组件

        Args:
            access_key_id: 阿里云访问密钥ID
            access_key_secret: 阿里云访问密钥
            endpoint: OSS服务终端节点
            **kwargs: 其他组件参数
        """
        super().__init__(**kwargs)
        self.access_key_id = access_key_id
        self.access_key_secret = access_key_secret
        self.endpoint = endpoint

    async def _arun(self, args: OssInput, **kwargs: Any) -> OssOutput:
        """执行OSS操作

        Args:
            args: OssInput包含bucket, key, operation和content
            **kwargs: 其他参数

        Returns:
            OssOutput: 操作结果
        """
        # 创建认证和Bucket对象
        auth = oss2.Auth(self.access_key_id, self.access_key_secret)

        try:
            if args.operation == "read":
                # 读取文件
                bucket = oss2.Bucket(auth, self.endpoint, args.bucket)
                result = bucket.get_object(args.key)
                content = result.read().decode("utf-8")
                return OssOutput(
                    success=True,
                    content=content,
                    message=f"文件 {args.key} 读取成功",
                )
            elif args.operation == "write":
                # 写入文件
                bucket = oss2.Bucket(auth, self.endpoint, args.bucket)
                bucket.put_object(args.key, args.content)
                return OssOutput(
                    success=True,
                    message=f"文件 {args.key} 写入成功",
                )
            elif args.operation == "delete":
                # 删除文件
                bucket = oss2.Bucket(auth, self.endpoint, args.bucket)
                bucket.delete_object(args.key)
                return OssOutput(
                    success=True,
                    message=f"文件 {args.key} 删除成功",
                )
            else:
                return OssOutput(success=False, message="不支持的操作类型")
        except Exception as e:
            return OssOutput(success=False, message=str(e))


# 示例使用
if __name__ == "__main__":
    import asyncio

    # 初始化组件（需要替换为实际的AK信息）
    oss_component = OssComponent(
        access_key_id="your_access_key_id",
        access_key_secret="your_access_key_secret",  # pragma: allowlist secret
        endpoint="https://oss-cn-beijing.aliyuncs.com",
        name="oss_reader",
        description="读取OSS文件",
    )

    async def main() -> None:
        # 读取文件示例
        oss_input = OssInput(
            bucket="my-bucket",
            key="data/file.txt",
            operation="read",
        )

        result = await oss_component.arun(oss_input)
        print(f"操作结果: {result.success}")
        print(f"消息: {result.message}")
        if result.content:
            print(f"内容: {result.content}")

    # asyncio.run(main())
